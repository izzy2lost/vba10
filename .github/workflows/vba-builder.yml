name: VBA Builder

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag Name'
        required: true
        default: 'v1.0.0'
      package_name:
        description: 'Package Name'
        required: true
        default: 'VBA'

jobs:
  build:
    runs-on: windows-latest

    env:
      SolutionPath: VBA10.sln
      Platform: x64
      Configuration: Release
      BuildMode: SideLoadOnly
      AppxBundle: Never
      ProjectPath: VBA10.vcxproj
      ProjectDirectory: .\
      PackageOutputRootDir: C:\AppPackage
      PackageOutputDir: VBA
      TargetPlatformVersion: '10.0.10240.0' # Specific SDK version

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Download Windows SDK
        run: |
          Invoke-WebRequest -Uri 'https://go.microsoft.com/fwlink/p/?LinkId=619296' -OutFile 'winsdksetup.exe'
        shell: pwsh

      - name: Install Windows SDK
        run: |
          Start-Process -FilePath .\winsdksetup.exe -ArgumentList '/features OptionId.WindowsDesktopHeaders OptionId.WindowsDesktopLibs OptionId.WindowsDesktopTools OptionId.UWPManagedTools OptionId.UWPManagedTools OptionId.UWPManagedLibs OptionId.UWPHeaders OptionId.UWPLibs OptionId.UWPAppDeployment OptionId.WindowsAppCertKit OptionId.WindowsSDKDesktop OptionId.WindowsSDKDesktopCore OptionId.NetFX4Extended /quiet /norestart /log log.txt' -NoNewWindow -Wait
          Start-Sleep -Seconds 300  # Sleep to give time for the installation to complete
          Get-Content log.txt
        shell: pwsh

      - name: Restart Machine
        run: |
          Restart-Computer -Force 
        shell: pwsh       

      - name: Verify Windows SDK Installation
        run: |
          if (Test-Path 'C:\Program Files (x86)\Windows Kits\10\bin\10.0.10240.0') {
            Write-Host "Windows SDK 10.0.10240.0 is installed."
          } else {
            Write-Host "Windows SDK 10.0.10240.0 is not installed."
            exit 1
          }
        shell: pwsh

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup NuGet.exe for use with actions
        uses: NuGet/setup-nuget@v1.1.1

      - name: Install SQLite UWP SDK
        run: |
          # Download the VSIX package from the Visual Studio Marketplace
          Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/_apis/public/gallery/publishers/SQLiteDevelopmentTeam/vsextensions/SQLiteforUniversalWindowsPlatform/3.38.0/vspackage' -OutFile 'sqlite-uwp.vsix'
          # Install the downloaded VSIX package
          Start-Process -FilePath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\VSIXInstaller.exe" -ArgumentList '/quiet', 'sqlite-uwp.vsix' -Wait

      - name: Generate Self-Signed Certificate
        id: generate_cert
        run: |
          $cert = New-SelfSignedCertificate -CertStoreLocation "Cert:\CurrentUser\My" -Subject "CN=MyUWPCert" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -NotAfter (Get-Date).AddYears(1) -Type CodeSigningCert
          echo "THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Set Package Name
        id: set_package_name
        run: echo "PACKAGE_NAME=${{ github.event.inputs.package_name }}_${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV

      - name: App Build
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\msbuild.exe" $env:SolutionPath `
            /p:Platform=$env:Platform `
            /p:Configuration=$env:Configuration `
            /p:UapAppxPackageBuildMode=$env:BuildMode `
            /p:AppxBundle=$env:AppxBundle `
            /p:PackageCertificateThumbprint="${{ env.THUMBPRINT }}" `
            /p:AppxPackageTestDir="${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}" `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=$env:TargetPlatformVersion `
            /p:RestorePackagesConfig=true `
            /restore 
        shell: pwsh

      - name: Clean the Package
        run: |
          $PackagePath = "${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}"
          if (Test-Path $PackagePath) {
            Write-Host "Cleaning package directory: $PackagePath"
            Remove-Item -Recurse -path "$PackagePath\Add-AppDevPackage.resources" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\TelemetryDependencies" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\Dependencies\arm" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\Dependencies\arm64" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\Dependencies\x86" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\Dependencies\Win32" -ErrorAction SilentlyContinue
            Remove-Item -path "$PackagePath\Add-AppDevPackage.ps1" -ErrorAction SilentlyContinue
            Remove-Item -Recurse -path "$PackagePath\Install.ps1" -ErrorAction SilentlyContinue
          } else {
            Write-Host "Package path does not exist: $PackagePath"
            exit 1
          }
        shell: pwsh

      - name: Create Archive
        run: |
          $PackagePath = "${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}"
          if (Test-Path $PackagePath) {
            Write-Host "Creating archive for: $PackagePath"
            Compress-Archive -Path "$PackagePath\*" -DestinationPath "${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}.zip"
            Write-Host "Contents of package output directory after archiving:"
            Get-ChildItem -Path "${{ env.PackageOutputRootDir }}" -Recurse
          } else {
            Write-Host "Package path does not exist for archiving: $PackagePath"
            exit 1
          }
        shell: pwsh

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.package_name }} Build
          path: ${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}.zip
